var e;e=function(){var t=function(){function e(t){return s.appendChild(t.dom),t}function i(t){for(var e=0;e<s.children.length;e++)s.children[e].style.display=e===t?"block":"none";n=t}var n=0,s=document.createElement("div");s.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",s.addEventListener("click",function(t){t.preventDefault(),i(++n%s.children.length)},!1);var o=(performance||Date).now(),a=o,r=0,h=e(new t.Panel("FPS","#0ff","#002")),l=e(new t.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var d=e(new t.Panel("MB","#f08","#201"));return i(0),{REVISION:16,dom:s,addPanel:e,showPanel:i,begin:function(){o=(performance||Date).now()},end:function(){r++;var t=(performance||Date).now();if(l.update(t-o,200),t>a+1e3&&(h.update(1e3*r/(t-a),100),a=t,r=0,d)){var e=performance.memory;d.update(e.usedJSHeapSize/1048576,e.jsHeapSizeLimit/1048576)}return t},update:function(){o=this.end()},domElement:s,setMode:i}};return t.Panel=function(t,e,i){var n=1/0,s=0,o=Math.round,a=o(window.devicePixelRatio||1),r=80*a,h=48*a,l=3*a,d=2*a,u=3*a,c=15*a,f=74*a,p=30*a,y=document.createElement("canvas");y.width=r,y.height=h,y.style.cssText="width:80px;height:48px";var w=y.getContext("2d");return w.font="bold "+9*a+"px Helvetica,Arial,sans-serif",w.textBaseline="top",w.fillStyle=i,w.fillRect(0,0,r,h),w.fillStyle=e,w.fillText(t,l,d),w.fillRect(u,c,f,p),w.fillStyle=i,w.globalAlpha=.9,w.fillRect(u,c,f,p),{dom:y,update:function(h,x){n=Math.min(n,h),s=Math.max(s,h),w.fillStyle=i,w.globalAlpha=1,w.fillRect(0,0,r,c),w.fillStyle=e,w.fillText(o(h)+" "+t+" ("+o(n)+"-"+o(s)+")",l,d),w.drawImage(y,u+a,c,f-a,p,u,c,f-a,p),w.fillRect(u+f-a,c,a,p),w.fillStyle=i,w.globalAlpha=.9,w.fillRect(u+f-a,c,a,o((1-h/x)*p))}}},t},"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):this.Stats=e(),function(){var e=window;const i=320,n=200,s=i*n,o=s,a=2*s,r=9*s,l=Math;Object.getOwnPropertyNames(l).forEach(t=>e[t]=e[t]||l[t]),viewX=0,viewY=0,viewW=i,viewH=n,cursorX=0,cursorY=0,cursorColor=22,cursorColor2=0,floodStack=[],fontString="ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890_!@#.'\"?/<()",fontBitmap="11111100011111110001100011111010001111101000111110111111000010000100000111111100100101000110001111101111110000111001000011111111111000011100100001000011111100001011110001111111000110001111111000110001111110010000100001001111111111000100001010010111101000110010111001001010001100001000010000100001111110001110111010110001100011000111001101011001110001011101000110001100010111011110100011001011100100000111010001100011001001111111101000111110100011000101111100000111000001111101111100100001000010000100100011000110001100010111010001100011000101010001001000110001101011010101110100010101000100010101000110001010100010000100001001111100010001000100011111001000110000100001000111001110100010001000100111111111000001001100000111110100101001011111000100001011111100001111000001111100111110000111101000101110111110000100010001000010001110100010111010001011100111010001011110000101110011101000110001100010111000000000000000000000111110010000100001000000000100111111000110111101011011101010111110101011111010100000000000000000000000100001100001000100000000000011011010011001000000000000111010001001100000000100000010001000100010001000000010001000100000100000100001000100001000010000010",dither=[65535,65527,65015,65013,62965,62901,58805,58789,42405,42401,42145,42144,41120,40992,32800,32768,0],pat=65535,palDefault=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63];var d=document.getElementById("canvas"),u=(document.createElement("canvas").getContext("2d"),d.getContext("2d")),c=0,f=a,p=[4278715910,4279439380,4280620859,4281145203,4280950964,4280499935,4278872826,4280001529,4282504703,4282449151,4284805846,4282637212,4281712985,4281245716,4282284570,4282077732,4280295442,4284757012,4291058728,4292779812,4291286560,4292607142,4294967295,4290835454,4290303738,4288127221,4285754088,4288367292,4286593657,4283642688,4281606692,4279901218,4280822578,4282073457,4282873275,4284720347,4288467700,4293583066,4291934643,4289696651,4287460717,4284634186,4282464563,4281541698,4281872731,4283585166,4285167034,4288919017,4294960867,4294688697,4293172100,4290678104,4286938439,4283328291,4284777522,4287475549,4290436242,4293064653,4289385188,4287344839,4284647072,4283787129,4282666586,4281612610,4278190080];pal=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64],u.imageSmoothingEnabled=!1,d.width=i,d.height=n;var w=u.getImageData(0,0,i,n),x=new ArrayBuffer(w.data.length),g=new Uint8Array(x),v=new Uint32Array(x),m=new Uint8Array(i*n*20);function C(t,e,s=64){return!(0-s>t||t>i+s||0-s>e||e>n+s)}function b(t=0,e=c){m.fill(t,e,e+s)}function I(t=cursorColor,e=cursorColor2){cursorColor=t,cursorColor2=e}function D(t,e){let s=(e|=0)%4*4+(t|=0)%4,o=pat&Math.pow(2,s),a=o?cursorColor:cursorColor2;64!=a&&(a>64&&(a=0),0>t|t>i-1||0>e|e>n-1||(m[c+e*i+t]=o?cursorColor:cursorColor2))}function Y(t,e,i,n,s=cursorColor,o=cursorColor2){cursorX=i,cursorY=n,cursorColor2=o,cursorColor=s;var a,r,h=(n|=0)-(e|=0),l=(i|=0)-(t|=0);if(0>h?(h=-h,r=-1):r=1,0>l?(l=-l,a=-1):a=1,h<<=1,l<<=1,D(t,e),l>h)for(var d=h-(l>>1);t!=i;)0>d||(e+=r,d-=l),d+=h,D(t+=a,e);else for(d=l-(h>>1);e!=n;)0>d||(t+=a,d-=h),d+=l,D(t,e+=r)}function E(t,e,i=16,n=16,s=cursorColor,o=cursorColor2){cursorColor2=o,cursorColor=s,x1=0|t,y1=0|e,i|=0,n|=0,Y(x1,y1,i,y1,s),Y(i,y1,i,n,s),Y(x1,n,i,n,s),Y(x1,y1,x1,n,s)}function X(t,e,i=16,n=16,s=cursorColor,o=cursorColor2){cursorColor2=o,cursorColor=s,x1=0|t,y1=0|e,i|=0,s|=0;var a=(n|=0)-y1;if(Y(x1,y1,i,y1,s),a>0)for(;--a;)Y(x1,y1+a,i,y1+a,s);else if(0>a)for(;++a;)Y(x1,y1+a,i,y1+a,s);Y(x1,n,i,n,s)}function S(t=0,e=0,s=i,o=n,a=0,r=0,h=!1,l=!1,d=pal){t|=0,e|=0,s|=0,o|=0,a|=0,r|=0;for(var u=0;o>u;u++)for(var p=0;s>p;p++)n>r+u&&i>a+p&&r+u>-1&&a+p>-1&&(h&l?0>m[f+((e+(o-u))*i+t+(s-p))]||(m[c+((r+u)*i+a+p)]=d[m[f+((e+(o-u-1))*i+t+(s-p-1))]]):l&&!h?0>m[f+((e+(o-u))*i+t+p)]||(m[c+((r+u)*i+a+p)]=d[m[f+((e+(o-u-1))*i+t+p)]]):h&&!l?0>m[f+((e+u)*i+t+(s-p-1))]||(m[c+((r+u)*i+a+p)]=d[m[f+((e+u)*i+t+(s-p-1))]]):h||l||0>m[f+((e+u)*i+t+p)]||(m[c+((r+u)*i+a+p)]=d[m[f+((e+u)*i+t+p)]]))}function R(e){e[7]||(e[7]=1),e[8]||(e[8]=1);for(var i=e[0].length,n=0;i>n;n++){var s;r=e[0].charAt(n),index=fontString.indexOf(r),s=fontBitmap.substring(25*index,25*index+25).split("");for(var o=0;5>o;o++)for(var a=0;5>a;a++)if(1==s[5*o+a])if(1==e[4])D(e[1]+a*e[4]+(5*e[4]+e[3])*n,e[2]+(e[6]?Math.sin(1*(t+n*e[8])/e[7])*e[6]:0)+o*e[4]|0);else{let i=e[1]+a*e[4]+(5*e[4]+e[3])*n,s=e[2]+(e[6]?Math.sin(1*(t+n*e[8])/e[7])*e[6]:0)+o*e[4]|0;X(i,s,i+e[4],s+e[4],e[5])}}var r}function K(t){var e=5*t[7],i=t[0].split("\n"),n=i.slice(0),s=i.length,o=n.sort(function(t,e){return e.length-t.length})[0],a=o.length*e+(o.length-1)*t[3],r=s*e+(s-1)*t[4];t[5]||(t[5]="left"),t[6]||(t[6]="bottom");var h=t[1],l=t[2],d=t[1]+a,u=t[2]+r;"center"==t[5]?(h=t[1]-a/2,d=t[1]+a/2):"right"==t[5]&&(h=t[1]-a,d=t[1]),"center"==t[6]?(l=t[2]-r/2,u=t[2]+r/2):"bottom"==t[6]&&(l=t[2]-r,u=t[2]);for(var c=h+a/2,f=l+r/2,p=0;s>p;p++){var y=i[p],w=y.length*e+(y.length-1)*t[3],x=t[1],g=t[2]+(e+t[4])*p;"center"==t[5]?x=t[1]-w/2:"right"==t[5]&&(x=t[1]-w),"center"==t[6]?g-=r/2:"bottom"==t[6]&&(g-=r),R([y,x,g,t[3]||0,t[7]||1,t[8],t[9],t[10],t[11]])}return{sx:h,sy:l,cx:c,cy:f,ex:d,ey:u,width:a,height:r}}function P(t,e=1,i=0,n=.5,s=!1){var o=audioCtx.createBufferSource(),a=audioCtx.createGain(),r=audioCtx.createStereoPanner();return o.buffer=t,o.connect(r),r.connect(a),a.connect(audioMaster),o.playbackRate.value=e,o.loop=s,a.gain.value=n,r.pan.value=i,o.start(),{volume:a,sound:o}}function M(t=Date.now(),e=1664525,i=1013904223,n=Math.pow(2,32)){this.seed=t,this.a=e,this.c=i,this.m=n}audioCtx=new AudioContext,Number.prototype.clamp=function(t,e){return Math.min(Math.max(this,t),e)},Number.prototype.map=function(t,e,i,n){return(this-t)/(e-t)*(n-i)+i},Number.prototype.pad=function(t,e="0"){for(var i=String(this);i.length<(t||2);)i=e+i;return i},Key={_pressed:{},_released:{},LEFT:37,UP:38,RIGHT:39,DOWN:40,SPACE:32,ONE:49,TWO:50,THREE:51,FOUR:52,a:65,c:67,w:87,s:83,d:68,z:90,x:88,f:70,p:80,r:82,isDown(t){return this._pressed[t]},justReleased(t){return this._released[t]},onKeydown(t){this._pressed[t.keyCode]=!0},onKeyup(t){this._released[t.keyCode]=!0,delete this._pressed[t.keyCode]},update(){this._released={}}},M.prototype.setSeed=function(t){this.seed=t},M.prototype.nextInt=function(){return this.seed=(this.seed*this.a+this.c)%this.m,this.seed},M.prototype.nextFloat=function(){return this.nextInt()/this.m},M.prototype.nextBool=function(t){return null==t&&(t=.5),this.nextFloat()<t},M.prototype.nextFloatRange=function(t,e){return t+this.nextFloat()*(e-t)},M.prototype.nextIntRange=function(t,e){return Math.floor(this.nextFloatRange(t,e))},M.prototype.nextColor=function(){for(var t=this.nextIntRange(0,Math.pow(2,24)).toString(16).toUpperCase();6>t.length;)t="0"+t;return"#"+t};var G=function(){var t,e,i,n,s,o=function(t){return Math.sin(6.283184*t)},a=function(t){return.003959503758*Math.pow(2,(t-128)/12)},r=function(t,e,i){var n,s,o,r,l,d,u,c=h[t.i[0]],f=t.i[1],p=t.i[3],y=h[t.i[4]],w=t.i[5],x=t.i[8],g=t.i[9],v=t.i[10]*t.i[10]*4,m=t.i[11]*t.i[11]*4,C=t.i[12]*t.i[12]*4,b=1/C,I=t.i[13],D=i*Math.pow(2,2-t.i[14]),Y=new Int32Array(v+m+C),E=0,X=0;for(n=0,s=0;v+m+C>n;n++,s++)0>s||(s-=D,d=a(e+(15&(I=I>>8|(255&I)<<4))+t.i[2]-128),u=a(e+(15&I)+t.i[6]-128)*(1+8e-4*t.i[7])),o=1,v>n?o=n/v:v+m>n||(o-=(n-v-m)*b),r=d,p&&(r*=o*o),l=c(E+=r)*f,r=u,x&&(r*=o*o),l+=y(X+=r)*w,g&&(l+=(2*Math.random()-1)*g),Y[n]=80*l*o|0;return Y},h=[o,function(t){return.5>t%1?1:-1},function(t){return t%1*2-1},function(t){var e=t%1*4;return 2>e?e-1:3-e}];this.init=function(o){t=o,e=o.endPattern,i=0,n=o.rowLen*o.patternLen*(e+1)*2,s=new Int32Array(n)},this.generate=function(){var a,l,d,u,c,f,p,y,w,x,g,v,m,C,b=new Int32Array(n),I=t.songData[i],D=t.rowLen,Y=t.patternLen,E=0,X=0,S=!1,R=[];for(d=0;e>=d;++d)for(p=I.p[d],u=0;Y>u;++u){var K=p?I.c[p-1].f[u]:0;K&&(I.i[K-1]=I.c[p-1].f[u+Y]||0,16>K&&(R=[]));var P=h[I.i[15]],M=I.i[16]/512,G=Math.pow(2,I.i[17]-9)/D,A=I.i[18],L=I.i[19],k=43.23529*I.i[20]*3.141592/44100,O=1-I.i[21]/255,z=1e-5*I.i[22],H=I.i[23]/32,j=I.i[24]/512,F=6.283184*Math.pow(2,I.i[25]-9)/D,T=I.i[26]/255,B=I.i[27]*D&-2;for(g=(d*Y+u)*D,c=0;4>c;++c)if(f=p?I.c[p-1].n[u+c*Y]:0){R[f]||(R[f]=r(I,f,D));var N=R[f];for(l=0,a=2*g;l<N.length;l++,a+=2)b[a]+=N[l]}for(l=0;D>l;l++)(x=b[y=2*(g+l)])||S?(v=k,A&&(v*=P(G*y)*M+.5),X+=(v=1.5*Math.sin(v))*(m=O*(x-X)-(E+=v*X)),x=3==L?X:1==L?m:E,z&&(x=1>(x*=z)?x>-1?o(.25*x):-1:1,x/=z),S=(x*=H)*x>1e-5,C=x*(1-(w=Math.sin(F*y)*j+.5)),x*=w):C=0,B>y||(C+=b[y-B+1]*T,x+=b[y-B]*T),b[y]=0|C,b[y+1]=0|x,s[y]+=0|C,s[y+1]+=0|x}return++i/t.numChannels},this.createWave=function(){var t=44+2*n-8,e=t-36,i=new Uint8Array(44+2*n);i.set([82,73,70,70,255&t,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&e,e>>8&255,e>>16&255,e>>24&255]);for(var o=0,a=44;n>o;++o){var r=s[o];r=-32767>r?-32767:r>32767?32767:r,i[a++]=255&r,i[a++]=r>>8&255}return i},this.getBuffer=function(){return s},this.getData=function(t,e){for(var i=2*Math.floor(44100*t),n=new Array(e),o=0;2*e>o;o+=1){var a=i+o;n[o]=t>0&&a<s.length?s[a]/32768:0}return n}},A={songData:[{i:[3,138,116,0,0,138,128,4,0,0,47,48,166,124,3,0,139,4,1,3,64,160,3,32,147,4,121,5],p:[1,1,4,2,3],c:[{n:[111],f:[]},{n:[114],f:[]},{n:[113],f:[]},{n:[112,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,113],f:[]}]}],rowLen:5513,patternLen:32,endPattern:4,numChannels:1},L={songData:[{i:[1,100,128,1,3,201,128,0,1,55,0,6,36,40,1,0,195,6,1,2,135,44,40,32,125,6,0,6],p:[1],c:[{n:[140],f:[]}]}],rowLen:5513,patternLen:32,endPattern:0,numChannels:1},k={songData:[{i:[1,100,128,1,2,201,128,0,1,75,0,6,93,40,1,0,195,6,0,2,60,0,1,15,125,4,0,0],p:[1],c:[{n:[123],f:[]}]}],rowLen:5513,patternLen:10,endPattern:0,numChannels:1};function O(e,i,n,s=8,o=0){this.colors=[18,5,27,19],this.color=p[o],this.x=e,this.y=i,this.oldX=0,this.oldY=0,this.width=s,this.height=s,this.startHealth=n,this.health=n,this.hit=!1,this.facingLeft=!0,this.following=!1,this.biting=!1,this.draw=function(){this.oldX=this.x,this.oldY=this.y;let e=this.x-viewX,i=this.y-viewY,n=t%30>15;C(e,i,24)&&(X(e,i-n,e+this.width,i+this.height,0,0),E(e,i-n,e+this.width,i+this.height,this.color,this.color),this.following,this.biting,this.health<this.startHealth&&(I(12,12),E(e,i-3,e+this.health,i-2)),0>this.health&&this.kill())},this.update=function(){let e=this.x-viewX,i=this.y-viewY;this.following=!1,this.biting=!1;let n=10>t%30;if(C(e,i,24)){this.x+=random()>.5?n:-n,this.y+=random()>.5?n:-n;let t=player.x-this.x,e=player.y-this.y,i=sqrt(e*e+t*t),s=atan2(e,t);100>i&&(this.following=!0,this.x+=cos(s)*random(),this.y+=sin(s)*random()),rectCollision(this,player)&&(player.hit=!0,this.biting=!0),this.hit&&(this.health-=1,this.hit=!1),1!=getGID(this.x,this.y)&&1!=getGID(this.x+this.width,this.y)&&1!=getGID(this.x+this.width,this.y+this.height)&&1!=getGID(this.x,this.y+this.height)||(this.x=this.oldX,this.y=this.oldY)}},this.kill=function(){let t=this.x-viewX,e=this.y-viewY;P(sounds.sndSplode1,1,0,.7,!1),function(t,e,i=5,n=cursorColor,s=cursorColor2){if(cursorColor2=s,cursorColor=n,t|=0,e|=0,n|=0,(i|=0)>=0){t|=0,e|=0,n|=0;var o=-(i|=0),a=0,r=2-2*i;do{Y(t-o,e-a,t+o,e-a,n),Y(t-o,e+a,t+o,e+a,n),(i=r)>a||(r+=2*++a+1),(i>o||r>a)&&(r+=2*++o+1)}while(0>o)}}(t+this.width/2,e+this.width/2,2*this.width,22,22),enemies.splice(enemies.indexOf(this),1)}}function z(t,e,i,n,s){this.x=t,this.y=e,this.width=4,this.height=4,this.xspeed=n,this.yspeed=s,this.life=90,this.draw=function(){this.oldX=this.x,this.oldY=this.y;let t=this.x-viewX,e=this.y-viewY;C(t,e,24)&&(pat=dither[15*random()|0],I(this.color,22),X(t,e,t+4,e+4,this.color,22),pat=dither[8])},this.update=function(){this.life--,this.oldX=this.x,this.oldY=this.y,this.x+=this.xspeed,this.y+=this.yspeed,this.x,viewX,this.y,viewY,1==getGID(this.x,this.y)&&this.kill(),0>this.life&&this.kill()},this.kill=function(){for(let t=0;40>t;t++)particles.push(new H(this.x,this.y,22,3*random()-1.5,3*random()-1.5));bullets.splice(bullets.indexOf(this),1)}}function H(t,e,i,n,s){this.x=t,this.y=e,this.width=1,this.height=1,this.xspeed=n,this.yspeed=s,this.life=40,this.draw=function(){this.oldX=this.x,this.oldY=this.y;let t=this.x-viewX,e=this.y-viewY;C(t,e,24)&&(I(7,4),D(t,e))},this.update=function(){this.life--,this.oldX=this.x,this.oldY=this.y,this.x+=this.xspeed,this.y+=this.yspeed,this.x,viewX,this.y,viewY,1==getGID(this.x,this.y)&&this.kill(),0>this.life&&this.kill()},this.kill=function(){particles.splice(particles.indexOf(this),1)}}player={x:5760,y:3200,oldX:0,oldY:0,vx:2,vy:2,width:6,height:10,color:12,gravity:gravity=4,health:100,tx:0,ty:0,steps:0,gid:0,hit:!1,xm:0,ym:0,draw:function(t){let e=this.x-viewX,i=this.y-viewY,n=this.steps%28>14?0:1,s=this.steps%40>20?0:1;X(e+1,i+s,e+5,i+4+s,22,22),X(e,i+1+s,e+this.width,i+3+s),X(e+2,i+2,e+4,i+8),D(e,i+7),D(e+6,i+7),Y(e+1,i+6,e+5,i+6),Y(e+1,i+9,e+1,i+10+n),Y(e+5,i+9,e+5,i+10+!n)},fire:function(){if(1>t%7){let t=hypot(gp.axes[2],gp.axes[3]),e=gp.axes[2]/t*6,i=gp.axes[3]/t*6;bullets.push(new z(this.x+3,this.y+5,9,e,i)),P(sounds.sndGun,1,0,.5,0)}},mouseFire:function(){if(1>t%7){let t=this.x-viewX,e=this.y-viewY,i=mouse.x-t,n=mouse.y-e,s=hypot(i,n),o=i/s*6,a=n/s*6;bullets.push(new z(this.x+3,this.y+5,9,o,a)),P(sounds.sndGun,.7,0,.3,0)}},update:function(){if(this.oldX=player.x,this.oldY=player.y,player.x,viewX,player.y,viewY,this.xm=1,this.hit&&(player.health-=.1,this.hit=!1),0>player.health&&(state="gameover"),Key.isDown(Key.d)||Key.isDown(Key.RIGHT)?(this.x+=this.vx,this.steps++):(Key.isDown(Key.a)||Key.isDown(Key.LEFT)||Key.isDown(Key.q))&&(this.x-=this.vx,this.steps++),Key.isDown(Key.w)||Key.isDown(Key.UP)||Key.isDown(Key.z)?(this.y-=this.vy,this.steps++):(Key.isDown(Key.s)||Key.isDown(Key.DOWN))&&(this.y+=this.vy,this.steps++),gp&&(buttonPressed(gp.buttons[3])?this.x+=this.vx:buttonPressed(gp.buttons[2])&&(this.x-=this.vx),buttonPressed(gp.buttons[0])?this.y-=this.vy:buttonPressed(gp.buttons[1])&&(this.y+=this.vy),abs(gp.axes[0])>.1&&(this.x+=this.vx*gp.axes[0]),abs(gp.axes[1])>.1&&(this.y+=this.vy*gp.axes[1]),abs(gp.axes[2])>.1&&this.fire(),abs(gp.axes[3])>.1&&this.fire(),1==mouse.pressed&&this.mouseFire()),1!=getGID(this.x,this.y)&&1!=getGID(this.x+this.width,this.y)&&1!=getGID(this.x+this.width,this.y+this.height)&&1!=getGID(this.x,this.y+this.height)||(this.x=this.oldX,this.y=this.oldY),Key.justReleased(Key.x)&&(2==getGID(this.x,this.y)||2==getGID(this.x+this.width-1,this.y)||2==getGID(this.x+this.width-1,this.y+this.height-1)||2==getGID(this.x,this.y+this.height-1))&&(foundSwitch=switches.find(function(t){return t.index==getIndex(this.x,this.y)}),foundSwitch&&(foundSwitch.state=1)),Key.isDown(Key.c)&&1>t%10){let t=5*this.xm,e=5*this.ym;bullets.push(new z(this.x+3,this.y+5,5,t,e))}}},switches=[],enemies=[],objects=[],bullets=[],particles=[],states={},gp=!1,mouse={x:0,y:0,pressed:!1},lcg=new M(1019),tileng=new M(42),init=(()=>{stats=new Stats,stats.showPanel(1),document.body.appendChild(stats.dom),canvas.addEventListener("mousemove",getMousePos),canvas.addEventListener("mousedown",getMousePos),drawMap(),createSwitches(),spawnEnemies(),state="menu",last=0,t=0,audioCtx=new AudioContext,audioMaster=audioCtx.createGain(),audioMaster.connect(audioCtx.destination),deadzoneX=70,deadzoneY=70,viewX=player.x-i/2,viewY=player.y-n/2,sounds={},sndData=[{name:"song",data:A},{name:"sndGun",data:L},{name:"sndSplode1",data:k}],sndData.forEach(function(t){var e=new G;e.init(t.data);var i=!1;setInterval(function(){if(!i&&(i=1==e.generate())){let i=e.createWave().buffer;audioCtx.decodeAudioData(i,function(e){sounds[t.name]=e})}},0)}),paused=!1,loop()}),window.addEventListener("keyup",function(t){Key.onKeyup(t)},!1),window.addEventListener("keydown",function(t){Key.onKeydown(t)},!1),window.addEventListener("blur",function(t){paused=!0},!1),window.addEventListener("focus",function(t){paused=!1},!1),window.addEventListener("gamepadconnected",function(t){t.gamepad.index,t.gamepad.id,t.gamepad.buttons.length,t.gamepad.axes.length}),loop=(e=>{stats.begin();var n=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[];gp=n[0],paused?(I(22,22),c=0,K(["PAUSED",i/2,128,3,1,"center","top",3,21,0]),audioMaster.gain.value=0):(dt=1,t+=1,audioMaster.gain.value=1,states[state].step(1),states[state].draw()),Key.update(),function(){let t=s;for(;t--;)v[t]=p[pal[m[t]]];w.data.set(g),u.putImageData(w,0,0)}(),stats.end(),requestAnimationFrame(loop)}),drawMap=(t=>{c=r,I(1,1),X(0,0,i,n,1,1);for(let t=0;900>t;t++){let t=lcg.nextIntRange(5,i-5),s=lcg.nextIntRange(5,n-5);e=lcg.nextIntRange(3,12),h=lcg.nextIntRange(3,12),X(t,s,t+e,s+h,0,0)}for(let t=0;10>t;t++){let e=10;y=t*(n-10)/10+5,X(e,y,e+i-30,y+1,0,0)}X(0,0,i,5,1,1),X(0,0,5,n,1,1),X(i-5,0,i,n,1,1),X(0,n-5,i,n,1),c=0}),createSwitches=(t=>{for(let t=0;100>t;t++){var e=lcg.nextIntRange(6,20),i=lcg.nextIntRange(13,16);c=r,I(2,2),D(e,i),c=0,switches.push({x:e,y:i,index:getIndex(32*e,32*i),color:[7,7,28,18][lcg.nextIntRange(0,3)],state:0})}}),drawSwitches=(t=>{switches.forEach(function(t){var e=32*t.y-viewY,i=32*t.x-viewX;if(C(i,e,32))switch(c=0,t.state){case 2:break;case 1:e=32*t.y-viewY,X(2+(i=32*t.x-viewX),e+2,i+32-2,e+32-2,t.color,0);break;default:e=32*t.y-viewY,X(2+(i=32*t.x-viewX),e+2,i+32-2,e+32-2,0,2)}})}),getIndex=((t,e)=>r+(t/32|0)+320*(e/32|0)),getGID=((t,e)=>m[getIndex(t,e)]),drawObjects=(t=>{objects.forEach(function(t){t.draw()})}),updateObjects=(t=>{objects.forEach(function(t){t.update()})}),updateCollisions=(t=>{enemiesOnScreen=enemies.filter(function(t){return C(t.x-viewX,t.y-viewY)}),enemiesOnScreen.forEach(function(t){bullets.forEach(function(e){rectCollision(t,e)&&(e.kill(),t.hit=!0)})})}),spawnEnemies=(t=>{for(let t=0;6e3>t;t++){let t=lcg.nextIntRange(0,i),e=lcg.nextIntRange(0,n);0==getGID(32*t,32*e)&&enemies.push(new O(32*t,32*e,10,lcg.nextIntRange(6,30),lcg.nextIntRange(0,3)))}}),rectCollision=((t,e)=>{let i=t.x,n=t.x+t.width,s=t.y,o=t.y+t.height,a=e.x,r=e.x+e.width,h=e.y,l=e.y+e.height;return!(a>n||i>r||h>o||s>l)}),buttonPressed=(t=>"object"==typeof t?t.pressed:1==t),getMousePos=(t=>{var e=d.getBoundingClientRect(),i=d.width/e.width,n=d.height/e.height;mouse={x:(t.clientX-e.left)*i|0,y:(t.clientY-e.top)*n|0,pressed:t.buttons}}),states.menu={step:function(t){Key.justReleased(Key.SPACE)&&(state="game")},draw:function(t){c=0,b(0),f=r,mapPal=[2,7],S(0,0,i,n,0,0,0,0,mapPal)}},states.game={step:function(t){player.update(t),player.x-viewX+deadzoneX>viewW?viewX=player.x-(viewW-deadzoneX):player.x-deadzoneX<viewX&&(viewX=player.x-deadzoneX),player.y-viewY+deadzoneY>viewH?viewY=player.y-(viewH-deadzoneY):player.y-deadzoneY<viewY&&(viewY=player.y-deadzoneY),enemies.forEach(function(t){t.update()}),bullets.forEach(function(t){t.update()}),particles.forEach(function(t){t.update()}),updateCollisions()},draw:function(t){pat=dither[8],c=o,b(0),X(0,0,i,n,2),c=0,b(0);let e=viewX/32-3|0,s=(viewX+i)/32+3|0,a=viewY/32-3|0,h=(viewY+n)/32+3|0;for(let t=e;s>t;t++)for(let i=a;h>i;i++){let n,s,o=m[r+320*i+t];switch(tileng.seed=e+320*i+h+t,o){case 1:n=32*t-viewX,s=32*i-viewY,pat=dither[tileng.nextIntRange(0,15)],X(n,s,n+32,s+32,8,7);break;case 2:break;default:n=32*t-viewX,s=32*i-viewY,pat=dither[tileng.nextIntRange(0,15)],X(n,s,n+32,s+32,2,1)}}enemies.forEach(function(t){t.draw()}),bullets.forEach(function(t){t.draw()}),particles.forEach(function(t){t.draw()}),player.draw(),X(i-60,n-60,i-5,n-5,0,0),E(i-60,n-60,i-5,n-5,22,22),f=r,mapPal=[1,7],S(e-18,a-18,54,54,i-59,n-59,0,0,mapPal),I(22,22),D((player.x-viewX)/32+i-56+18,(player.y-viewY)/32+n-56+18),I(22,22),K(["HEALTH",5,5,1,1,"left","top",1,22,player.hit?2:0,4]),X(42,5,42+player.health/2,10,64,11),function(t=cursorX,e=cursorY,i=5,n=cursorColor,s=cursorColor2){cursorColor2=s,cursorColor=n,t|=0,e|=0,n|=0;var o=-(i|=0),a=0,r=2-2*i;do{D(t-o,e+a),D(t-a,e-o),D(t+o,e-a),D(t+a,e+o),(i=r)>a||(r+=2*++a+1),(i>o||r>a)&&(r+=2*++o+1)}while(0>o)}(mouse.x,mouse.y,3,22)}},states.gameover={step:function(t){Key.justReleased(Key.SPACE)&&(state="game")},draw:function(t){b(0),I(0,4),K(["GAME\nOVER",i/2,30,3,9,"center","top",10,4,16,10,3]),K(["PRESS SPACE TO PLAY AGAIN",i/2,160,2,9,"center","top",1,7,0])}},window.init()}();